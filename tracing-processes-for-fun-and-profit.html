<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="no-js"><!--<![endif]-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ROSEdu Techblog - Tracing processes for fun and profit</title>
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <link rel="stylesheet" href="./css/rosedu_links.css" type="text/css">
    <link rel="stylesheet" href="./css/syntax.css" type="text/css">
    <!--<link rel="stylesheet" type="text/css" href="/css/default.css"/>-->

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7579199-6']);
      _gaq.push(['_trackPageview']);

      (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div id="page" class="hentry">
      <header class="the-header">
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./" title="Home">ROSEdu Techblog</a></li>
                <li class="about"><a href="./about.html">About</a></li>
                <li class="people"><a href="./people.html">People</a></li>
                <li class="archive"><a href="./archive.html">Archive</a></li>
                <li class="category"><a href="./tags.html">Tags</a></li>
              </ul>
            </nav>

            <hr />

            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./archive.html" title="Archive">Latest Posts</a></li>
                <!--TODO: implement recent posts list -->
                <li><a href="./shell-tips-and-tricks-for-file-editing.html">Shell tips and tricks for log files</a></li>
                <li><a href="./git-is-the-answer-3.html">Git Is The Answer 3/3</a></li>
                <li><a href="./git-is-the-answer-2.html">Git Is The Answer 2/3</a></li>
              </ul>
            </nav>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <div class="body" role="main">
        <div class="unit-body">
          <div class="unit-inner unit-body-inner">
  <div class="entry-content">
    <article class="unit-article layout-post">
      <div class="unit-inner unit-article-inner">
        <div class="content">
          <div class="bd">
            <header>
              <div class="unit-head">
                <div class="unit-inner unit-head-inner">
                  <h1 class="h2 entry-title">
                    <a class="post_title" href="./tracing-processes-for-fun-and-profit.html" title="Tracing processes for fun and profit">Tracing processes for fun and profit</a>
                  </h1>
                </div><!-- unit-inner -->
              </div><!-- unit-head -->
            </header>

            <span class="date">
            <span class="published">Published on August 18, 2012</span>
            by
            <span class="author">Mihai Maruseac</span>
            </span>

            <br />
            <span class="meta">
              Tagged:
              <span class="tags"><a href="./tags/trace.html">trace</a>, <a href="./tags/strace.html">strace</a>, <a href="./tags/ptrace.html">ptrace</a></span>
            </span>

            <p>After talking about <a href="http://techblog.rosedu.org/valgrind-introduction.html" title="Valgrind introduction">Valgrind</a> and <a href="http://techblog.rosedu.org/gdb-a-basic-workflow.html" title="GDB - basic workflow">GDB</a>, it is time to present another useful program for developers and system administrators.</p>
<p>Often-overlooked, though common on most of the GNU/Linux systems, <code>strace</code> is a tool which traces system calls done by a process during its execution. However, this is only a simplistic point of view: using <code>strace</code>, you can filter by a group of system calls, you can profile your application from the syscalls point of view and you can trace signals sent to a process.</p>
<h3 id="simple-example">Simple Example</h3>
<p>The simplest possible use is of the form <code>strace command</code>. For example:</p>
<pre><code>$ strace ls
execve(&quot;/bin/ls&quot;, [&quot;ls&quot;], [/* 39 vars */]) = 0
brk(0)                                  = 0x92c000
...
access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)
...
open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=130982, ...}) = 0
mmap(NULL, 130982, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc4e95c2000
close(3)                                = 0
...
open(&quot;/lib/x86_64-linux-gnu/librt.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\340!\0\0\0\0\0\0&quot;..., 832) = 832
...
openat(AT_FDCWD, &quot;.&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC) = 3
getdents(3, /* 25 entries */, 32768)    = 880
getdents(3, /* 0 entries */, 32768)     = 0
close(3)                                = 0
...
write(1, &quot;1.c git&quot;..., 1221.c gitignore....
) = 122
...
exit_group(0)                           = ?</code></pre>
<p>In the above trace we have removed some of the lines to keep the output within reasonable limits. We have kept some relevant outputs, though.</p>
<p>From the above output we can observe how a process is started (first group) or ended (last group), how libraries and system options are read (second, third and fourth section), how directory entries are read (fifth section) and how the output is written to the output (sixth section).</p>
<p>As you can see, each line presents a syscall, giving information about all parameters and the return value of the call.</p>
<h3 id="how-is-this-useful">How Is This Useful?</h3>
<p>Only by looking at the output lines, can we quickly find out why our process doesn’t behave as expected or what it does behind the scenes. Let us see some examples.</p>
<p>First, consider a binary which takes too long to finish. Using <code>strace</code> we get this as the last few lines:</p>
<pre><code>read(3, &quot;\333\310'\16\\\363&lt;\244u\324&quot;, 4096) = 10
read(3, </code></pre>
<p>We see that the application stopped while trying to read data from the third file descriptor. Looking backwards we find:</p>
<pre><code>open(&quot;/dev/random&quot;, O_RDONLY)           = 3</code></pre>
<p>Using these clues, we can construct a new source file which will compile into an application which has the exact same bug and nothing more:</p>
<p>{% highlight cpp %} #include <stdio.h> #include <stdlib.h></p>
<h1 id="define-size-1000">define SIZE 1000</h1>
<p>int main () { char a[SIZE]; FILE *f = fopen(“/dev/random”, “r”); fgets(a, SIZE, f); return 0; } {% endhighlight %}</p>
<p>Of course, the building of a new application is not always needed. In our case, we see that we are reading from <code>dev/random</code>. Knowing that this requires entropy sources to generate the random stream, we understand why the process stopped. Changing the file to <code>dev/urandom</code> solves the bug for our toy application, therefore it must solve it for the original one as well. Or, we could generate more entropy to increase the speed of the application.</p>
<p>For the second example, let’s consider the problem of finding which configuration files are read when launching an application. This can be used to debug a faulty <code>vim</code> setting, to see what <code>*rc</code> files are read when launching <code>bash</code>, etc. In our case, we want to see the order in which <code>git</code> reads its configuration files to see what files are to be ignored from the repository (we have 4 options: global <code>.gitignore</code>, <code>.gitignore</code> in root folder or in a subdirectory and <code>.git/info/exclude</code>):</p>
<pre><code>$strace git status
...
access(&quot;.git/info/exclude&quot;, R_OK)       = 0
open(&quot;.git/info/exclude&quot;, O_RDONLY)     = 3
...
access(&quot;/home/mihai/.gitignore&quot;, R_OK)  = 0
open(&quot;/home/mihai/.gitignore&quot;, O_RDONLY) = 3
...
open(&quot;.gitignore&quot;, O_RDONLY)            = 4
...
open(&quot;tag/.gitignore&quot;, O_RDONLY)        = -1 ENOENT (No such file or directory)
...
open(&quot;_includes/.gitignore&quot;, O_RDONLY)  = -1 ENOENT (No such file or directory)
...
open(&quot;_layouts/.gitignore&quot;, O_RDONLY)   = -1 ENOENT (No such file or directory)
...</code></pre>
<p>Observer the multiple lines with error <code>-ENOENT</code>. Those files don’t exist in the filesystem. The fact that we can quickly observe this makes <code>strace</code> a perfect tool for finding out why a specific command doesn’t start anymore.</p>
<h3 id="too-much-output">Too Much Output</h3>
<p>A problem with the simplest case is that we get too much output and scanning through it takes a long time while also being error prone.</p>
<p>Fortunately, once we know what to look for, we can select only a group of system calls to be traced.</p>
<pre><code>$ strace -e openat,getdents ls
openat(AT_FDCWD, &quot;.&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC) = 3
getdents(3, /* 9 entries */, 32768)     = 256
getdents(3, /* 0 entries */, 32768)     = 0</code></pre>
<p>Here, we have traced only the <code>openat</code> and <code>getdents</code> system calls of the <code>ls</code> command.</p>
<p>Moreover, we can save the trace to a file for further analyzing.</p>
<pre><code>$ strace -o trace ls
$ wc -l trace
117 trace
$ head trace -n 3
execve(&quot;/bin/ls&quot;, [&quot;ls&quot;], [/* 39 vars */]) = 0
brk(0)                                  = 0xced000
access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</code></pre>
<p>Combining these two options lets you use the output of <code>strace</code> as input to other tools like <code>sed</code>, <code>awk</code>, <code>grep</code>, etc. This way, you can quickly determine what went wrong in your application.</p>
<h3 id="but-i-have-started-the-process..">But I Have Started The Process..</h3>
<p>Let’s consider another scenario. You have started a process and it is taking too much time to finish. You want to find out what it is doing right now. Restarting the process is not an option. Luckily, <code>strace</code> allows attaching to a running process:</p>
<pre><code>$ strace -p 5545
rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0
rt_sigaction(SIGCHLD, NULL, {SIG_DFL, [], 0}, 8) = 0
rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0
nanosleep({5, 0},</code></pre>
<p>The last argument is the process id of the faulty process.</p>
<h3 id="could-i-sniff-private-data-this-way">Could I Sniff Private Data This Way?</h3>
<p>This quickly raises a concern: couldn’t an attacker use <code>strace</code> over an existing <code>ssh</code> connection in order to make a Man In The Middle attack?</p>
<p>Actually, no. If the programmer behind <code>ssh</code> used the <code>prctl</code> system call disabling <code>PR_SET_DUMPABLE</code> (the capability to create crash dumps and to be traced), then only the superuser could trace the process.</p>
<p>In fact, some systems have gone a step further. Starting 2010, there is a Yama Linux Security Module. This includes a protection for ptrace. Having <code>1</code> in the <code>/proc/sys/kernel/yama/ptrace_scope</code> associated procfs file means that tracing is only possible only for children of the tracing process.</p>
<h3 id="what-about-subprocesses">What About Subprocesses?</h3>
<p>It is possible to trace subprocesses of an application by using the <code>-f</code> or <code>-ff</code> flag (the second one is used in conjuction with <code>-o</code> and creates one output file per each subprocess).</p>
<pre><code>$ strace -f ./a.out 
...
clone(Process 6187 attached
child_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f9de09ee9d0) = 6187
[pid  6186] wait4(6187, Process 6186 suspended
 &lt;unfinished ...&gt;
[pid  6187] rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0
[pid  6187] rt_sigaction(SIGCHLD, NULL, {SIG_DFL, [], 0}, 8) = 0
[pid  6187] rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0
[pid  6187] nanosleep({1, 0}, 0x7fff306a3cf0) = 0
[pid  6187] exit_group(0)               = ?
Process 6186 resumed
Process 6187 detached
&lt;... wait4 resumed&gt; [{WIFEXITED(s) &amp;&amp; WEXITSTATUS(s) == 0}], 0, NULL) =
6187
--- SIGCHLD (Child exited) @ 0 (0) ---
exit_group(0)                           = ?</code></pre>
<p>When tracing multiple processes, the PID of the process making a system call is written on the respective line. The tracing of a child starts as soon as it’s PID is returned to the parent (as a result of the <code>clone</code> system call).</p>
<h3 id="profiling-with-strace">Profiling With <code>strace</code></h3>
<p>Another thing that <code>strace</code> can do is help in profiling the application, considering the number of system calls. This could be useful, for example, to optimize the I/O calls done by the application.</p>
<pre><code>$ strace -c firefox
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 99.50    0.012001        1091        11           readahead
  0.31    0.000037           0      1456       972 recvfrom
  0.19    0.000023           0       963           poll
  0.00    0.000000           0       123           read
  0.00    0.000000           0       134        33 open
  0.00    0.000000           0       107           close
  0.00    0.000000           0         8         3 stat
  0.00    0.000000           0        87           fstat
  0.00    0.000000           0        16           lstat
  0.00    0.000000           0         8           lseek
  0.00    0.000000           0       189           mmap
  0.00    0.000000           0       148           mprotect
  0.00    0.000000           0        20           munmap
  0.00    0.000000           0         4           brk
  0.00    0.000000           0        17           rt_sigaction
  0.00    0.000000           0         1           rt_sigprocmask
  ....    ........           .       ...           ................
------ ----------- ----------- --------- --------- ----------------
100.00    0.012061                  3900      1079 total</code></pre>
<h3 id="but-i-dont-want-to-be-traced..">But I Don’t Want To Be Traced..</h3>
<p>In the end, let’s consider the case of an application which should be designed as untraceable as possible.</p>
<p>We already know how to prevent attaching from the outside of the process. If we want to also deny root tracing and starting the process under <code>strace</code> then we need to take some extra steps.</p>
<p>We know that each application can be under a single tracer. Thus, the obvious solution is to create a dummy tracer.</p>
<p>A better solution is to inspect whether the process is traced and act accordingly (exit forcibly, display dummy messages, etc.). To do this, you can either use the <code>ptrace</code> system call on top of which <code>strace</code> is implemented or use the <code>proc/[pid]/status</code> file, looking for <code>TracerPid</code>.</p>
<h3 id="conclusions">Conclusions</h3>
<p>The <code>strace</code> program is a good tool to have in your toolbox. Knowing how to use it will greatly improve your debugging experience.</p>
<p>However, using <code>strace</code> has some disadvantages as well. The traced process runs slower and each system call is done at least twice. You can also get a different behaviour while running a process under <code>strace</code>: either because some timing bugs will manifest, because some timeouts are reached or because someone has taken measures that the process cannot be properly traced.</p>
<p>In the end, remember that debugging doesn’t stop at <a href="http://techblog.rosedu.org/gdb-a-basic-workflow.html" title="GDB - basic workflow">GDB</a> and/or <a href="http://techblog.rosedu.org/valgrind-introduction.html" title="Valgrind introduction">Valgrind</a>. Beside <code>strace</code>, there is also <code>ltrace</code> for library calls and <code>perf</code> for profiling. These two tools will be presented in further articles.</p>

          </div>
        </div>
      </div>
<!-- Social Buttons here -->
	<div id="sociallinks">
  	<a href="https://twitter.com/home?status=/tracing-processes-for-fun-and-profit.html" target="_blank">Tweet this</a> -
  	<a href="http://www.facebook.com/sharer/sharer.php?u=/tracing-processes-for-fun-and-profit.html" target="_blank">Like this</a> -
  	<a href="https://plus.google.com/share?url=/tracing-processes-for-fun-and-profit.html" target="_blank">Share on G+</a>
	</div>
	<script>
		(function(){window.addEventListener("DOMContentLoaded",function(){
		//get URL 
    		var url=document.location;
    		var links=document.getElementById("sociallinks")
                      .getElementsByTagName('a');
    		for (var i=0;i!=links.length;i++){
			// Replacing /tracing-processes-for-fun-and-profit.html with current URL
        		links[i].setAttribute("href",
            		links[i].href.replace('/tracing-processes-for-fun-and-profit.html',url));}})})();
	</script>
	</br>
    </article>
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'rosedutechblog';
  var disqus_url = window.location.href.split('/').splice(0,3).join("/")+'/tracing-processes-for-fun-and-profit.html';
  var title = 'Tracing processes for fun and profit';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        </div>
      </div>

      <footer class="the-footer">
        <div class="unit-foot">
          <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
              <h4>Social</h4>
              <div class="rss">
                <a href="http://feeds.feedburner.com/rosedu/tech" target="_blank">
                  <img src="./images/rss.png" alt="Subscribe to RSS Feed" />
                </a>
                <a href="http://www.reddit.com/submit?url='+encodeURIComponent(window.location)" target="_blank" onclick="window.location='http://www.reddit.com/submit?url='+encodeURIComponent(window.location); return false">
                  <img src="./images/reddit.png" alt="Submit to Reddit" />
                </a>
                <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" target="_blank">
                  <img src="./images/twitter.png" alt="Submit to Twitter" />
                </a>
              </div>

              <h4>Powered by</h4>
              <ul>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://www.rosedu.org">ROSEdu</a>
                  </address>
                </li>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://jaspervdj.be/hakyll">Hakyll</a>
                  </address>
                </li>
              </ul>

              <h4>License</h4>
              <div class="bucket">
                <span>
                  <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution 3.0 License">
                    <img src="//i.creativecommons.org/l/by/3.0/88x31.png" alt="License">
                  </a>
                </span>
                <span>
                  This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" class="subfoot">Creative Commons Attribution 3.0 License</a>.
                </span>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>
