<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="no-js"><!--<![endif]-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ROSEdu Techblog - Stack Allocation</title>
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <link rel="stylesheet" href="./css/rosedu_links.css" type="text/css">
    <link rel="stylesheet" href="./css/syntax.css" type="text/css">

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7579199-6']);
      _gaq.push(['_trackPageview']);

      (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div id="page" class="hentry">
      <header class="the-header">
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./" title="Home">ROSEdu Techblog</a></li>
                <li class="about"><a href="./about.html">About</a></li>
                <li class="people"><a href="./people.html">People</a></li>
                <li class="archive"><a href="./archive.html">Archive</a></li>
                <li class="category"><a href="./tags.html">Tags</a></li>
              </ul>
            </nav>

            <hr />

            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./archive.html" title="Archive">Latest Posts</a></li>
                
                  <li><a href="./cdl-2015.html" title="Application process for the Community Development Lab">Application pro...</a></li>
                
                  <li><a href="./fp-dragons.html" title="Here be Dragons - The Interesting Realm of Floating Point Operations">Here be Dragons...</a></li>
                
                  <li><a href="./daemonizing-processes.html" title="Daemonizing Processes - Part 1">Daemonizing Pro...</a></li>
                
              </ul>
            </nav>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <div class="body" role="main">
        <div class="unit-body">
          <div class="unit-inner unit-body-inner">
            <div class="entry-content">
              <article class="unit-article layout-post">
                <div class="unit-inner unit-article-inner">
  <div class="content">
    <div class="bd">
      <header>
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <h1 class="h2 entry-title">
              <a class="post_title" href="./stack-allocation.html" title="Stack Allocation">Stack Allocation</a>
            </h1>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <span class="date">
      <span class="published">Published on December 18, 2011</span>
      by
      <span class="author"><a href="./people/alexandru-juncu.html">Alexandru Juncu</a></span>
      </span>

      <br />
      <span class="meta">
        Tagged:
        <span class="tags"><a title="All pages tagged 'stack'." href="./tags/stack.html">stack</a>, <a title="All pages tagged 'sp'." href="./tags/sp.html">sp</a>, <a title="All pages tagged 'esp'." href="./tags/esp.html">esp</a>, <a title="All pages tagged 'C'." href="./tags/c.html">C</a>, <a title="All pages tagged 'assembly'." href="./tags/assembly.html">assembly</a>, <a title="All pages tagged 'cache'." href="./tags/cache.html">cache</a>, <a title="All pages tagged 'memory'." href="./tags/memory.html">memory</a></span>
      </span>

      <p><strong>Stack space</strong> is the part of each process’ virtual memory where function arguments and return addresses are stored, along with local variables declared within a function. Usually, the stack begins at the high address space of the virtual memory and grows down.</p>
<!--more-->
<p>At every function call, a new <strong>stack frame</strong> is created on the stack. It contains the parameters sent to the function, the return address (the address of a code in the caller function) and the locally declared variables.</p>
<p>For each function call, the <code>SP/ESP</code> (Stack Pointer/Extended Stack Pointer) is set so the stack has a big enough size to accommodate local variables. For example, in theory, if you have a local <code>char</code> variable and an <code>int</code> variable, the SP should be set (moved) to 5 bytes.</p>
<p>In practice, the compiler will allocate stack space a little different than expected. It will allocate local variables space in increments of a fixed size, so sometimes having two int variables or three int variables will be the same.</p>
<p>As an example, <code>gcc</code> will allocate in increments of 16 bytes. Let’s make an experiment… we take a simple C program and turn into assembly code.</p>
<p>The C file looks something like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="dt">int</span> main(<span class="dt">void</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a>{</span>
<span id="cb1-3"><a href="#cb1-3"></a>	<span class="dt">int</span> a=<span class="dv">1</span>, b=<span class="dv">2</span>;</span>
<span id="cb1-4"><a href="#cb1-4"></a>	<span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb1-5"><a href="#cb1-5"></a>}</span></code></pre></div>
<p>The variables must be used after declaration or they will be ignored by the compiler.</p>
<p>The resulting assembly code (<code>gcc -S</code>) looks like this:</p>
<pre><code>main:
	pushl	%ebp
	movl	%esp, %ebp
	subl	$16, %esp
	movl	$1, -4(%ebp)
	movl	$2, -8(%ebp)
	movl	$0, %eax
	leave
	ret</code></pre>
<p>Notice the <code>subl</code> instruction that clears 16 bytes in the stack space by decrementing the ESP. Those 16 bytes are enough for four 32bit integers. If you have 1,2,3 or 4 local variables declared (and used), you get those 16 bytes.</p>
<p>If we declare 5 integers, the allocated space will now be 32bytes. Same thing for 6, 7, or 8. If we have 9 to 12 integers the compiler will allocate 48 bytes. An so on…</p>
<p>What if we don’t only have integers? Let’s add some chars.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">int</span> main(<span class="dt">void</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>{</span>
<span id="cb3-3"><a href="#cb3-3"></a>	<span class="dt">int</span> a=<span class="dv">1</span>, b=<span class="dv">2</span>;</span>
<span id="cb3-4"><a href="#cb3-4"></a>	<span class="dt">char</span> c=<span class="dv">3</span>, d=<span class="dv">4</span>;</span>
<span id="cb3-5"><a href="#cb3-5"></a>}</span></code></pre></div>
<p>Result:</p>
<pre><code>main:
	pushl	%ebp
	movl	%esp, %ebp
	subl	$16, %esp
	movl	$1, -8(%ebp)
	movl	$2, -12(%ebp)
	movb	$3, -1(%ebp)
	movb	$4, -2(%ebp)
	movl	$0, %eax
	leave
	ret</code></pre>
<p>The function would need 10 bytes, but still gets 16. So the allocation is in increments of 16 bytes no matter what.</p>
<p>The question remains why? It has to do with the cache alignment. The compiler will try to structure the memory usage so that the executed code can be easily fetched from memory and cached. A correct alignment will cause minimum cache misses for memory access.</p>
<p>Credits to Sofia Neață for help with initial observations and tests.</p>

    </div>
  </div>
</div>

<!-- Social Buttons here -->
<div id="sociallinks">
  <a href="https://twitter.com/home?status=/stack-allocation.html" target="_blank">Tweet this</a> -
  <a href="http://www.facebook.com/sharer/sharer.php?u=/stack-allocation.html" target="_blank">Like this</a> -
  <a href="https://plus.google.com/share?url=/stack-allocation.html" target="_blank">Share on G+</a>
</div>

<script>
  (function(){window.addEventListener("DOMContentLoaded",function(){
    //get URL
    var url=document.location;
    var links=document.getElementById("sociallinks")
                      .getElementsByTagName('a');
    for (var i=0;i!=links.length;i++){
      // Replacing /stack-allocation.html with current URL
      links[i].setAttribute("href",links[i].href.replace('/stack-allocation.html',url));
    }})})();
</script>
</br>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'rosedutechblog';
  var disqus_url = window.location.href.split('/').splice(0,3).join("/")+'/stack-allocation.html';
  var title = 'Stack Allocation';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

              </article>
              
            </div>
          </div>
        </div>
      </div>

      <footer class="the-footer">
        <div class="unit-foot">
          <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
              <h4>Social</h4>
              <div class="rss">
                <a href="http://techblog.rosedu.org/rss.xml" target="_blank">
                  <img src="./images/rss.png" alt="Subscribe to RSS Feed" />
                </a>
                <a href="http://www.reddit.com/submit?url='+encodeURIComponent(window.location)" target="_blank" onclick="window.location='http://www.reddit.com/submit?url='+encodeURIComponent(window.location); return false">
                  <img src="./images/reddit.png" alt="Submit to Reddit" />
                </a>
                <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" target="_blank">
                  <img src="./images/twitter.png" alt="Submit to Twitter" />
                </a>
              </div>

              <h4>Powered by</h4>
              <ul>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://www.rosedu.org">ROSEdu</a>
                  </address>
                </li>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://jaspervdj.be/hakyll">Hakyll</a>
                  </address>
                </li>
              </ul>

              <h4>License</h4>
              <div class="bucket">
                <span>
                  <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution 3.0 License">
                    <img src="//i.creativecommons.org/l/by/3.0/88x31.png" alt="License">
                  </a>
                </span>
                <span>
                  This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" class="subfoot">Creative Commons Attribution 3.0 License</a>.
                </span>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>
