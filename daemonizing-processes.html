<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="no-js"><!--<![endif]-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ROSEdu Techblog - Daemonizing Processes - Part 1</title>
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <link rel="stylesheet" href="./css/rosedu_links.css" type="text/css">
    <link rel="stylesheet" href="./css/syntax.css" type="text/css">

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7579199-6']);
      _gaq.push(['_trackPageview']);

      (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body>
    <div id="page" class="hentry">
      <header class="the-header">
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./" title="Home">ROSEdu Techblog</a></li>
                <li class="about"><a href="./about.html">About</a></li>
                <li class="people"><a href="./people.html">People</a></li>
                <li class="archive"><a href="./archive.html">Archive</a></li>
                <li class="category"><a href="./tags.html">Tags</a></li>
              </ul>
            </nav>

            <hr />

            <nav class="nav-global">
              <ul>
                <li class="logo"><a href="./archive.html" title="Archive">Latest Posts</a></li>
                
                  <li><a href="./daemonizing-processes.html" title="Daemonizing Processes - Part 1">Daemonizing Pro...</a></li>
                
                  <li><a href="./unix-auto.html" title="Unix portability. Autoconf, Automake, Libtool">Unix portabilit...</a></li>
                
                  <li><a href="./haskell-part2.html" title="A superficial exploration of Haskell, part 2: Lazy by default">A superficial e...</a></li>
                
              </ul>
            </nav>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <div class="body" role="main">
        <div class="unit-body">
          <div class="unit-inner unit-body-inner">
            <div class="entry-content">
              <article class="unit-article layout-post">
                <div class="unit-inner unit-article-inner">
  <div class="content">
    <div class="bd">
      <header>
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <h1 class="h2 entry-title">
              <a class="post_title" href="./daemonizing-processes.html" title="Daemonizing Processes - Part 1">Daemonizing Processes - Part 1</a>
            </h1>
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <span class="date">
      <span class="published">Published on March 23, 2014</span>
      by
      <span class="author"><a href="./people/matei-oprea.html">Matei Oprea</a></span>
      </span>

      <br />
      <span class="meta">
        Tagged:
        <span class="tags"><a href="./tags/c.html">C</a>, <a href="./tags/daemon.html">daemon</a>, <a href="./tags/fork.html">fork</a>, <a href="./tags/setsid.html">setsid</a>, <a href="./tags/nohup.html">nohup</a>, <a href="./tags/disown.html">disown</a></span>
      </span>

      <p>A special category of processes in Linux is that formed by <strong>daemon</strong> processes.</p>
<!--more-->

<section id="what-is-a-daemon" class="level3">
<h3>What is a daemon?</h3>
<p>A daemon is a program that runs as a background process, forever, without being directly affected by any user. Let’s run a command to see examples of some daemons.</p>
<p>We need to run a command which will tell us what processes are started by the <code>init</code> process (they must have a <code>PPID</code> of 1):</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">ps</span> -ef <span class="kw">|</span> <span class="kw">awk</span> <span class="st">'$3 == 1'</span></code></pre>
<p>The trimmed result will be the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ps</span> -ef <span class="kw">|</span> <span class="kw">awk</span> <span class="st">'$3 == 1'</span>
<span class="kw">root</span>       367     1  0 Mar08 ?        00:00:00 upstart-udev-bridge --daemon
<span class="kw">root</span>       398     1  0 Mar08 ?        00:00:00 /sbin/udevd --daemon
<span class="kw">syslog</span>     521     1  0 Mar08 ?        00:00:03 rsyslogd -c5
<span class="kw">102</span>        525     1  0 Mar08 ?        00:00:15 dbus-daemon --system --fork --activation=upstart
<span class="kw">avahi</span>      816     1  0 Mar08 ?        00:00:00 avahi-daemon: running [matei-Satellite-C660.local]</code></pre>
<p>In Linux, the parent process of a daemon is often the <code>init</code> process. To create a daemon, we need to <code>fork()</code> a child process and then exit (after that the process will be an <em>orphan process</em>), causing <code>init</code> to adopt the it as a child. A daemon is often started at boot time having the task of handling network requests or hardware activity.</p>
</section>
<section id="lets-code-a-daemon" class="level3">
<h3>Let’s code a Daemon</h3>
<p>In this article we will show how one can write a simple daemon process. First, we will show the long path of using <code>fork()</code> and <code>setsid()</code>.</p>
<p>First step (see <a href="http://web.archive.org/web/20120914180018/http://www.steve.org.uk/Reference/Unix/faq_2.html#SEC16" title="How to code a daemon">this FAQ</a> for reference) is to <code>fork</code> and <code>exit</code> such that the process is no longer a process leader:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="co">/*</span>
<span class="co"> * Fork the parent process</span>
<span class="co"> */</span>
pid = fork();
<span class="co">/* On failure, -1 is returned in the parent</span>
<span class="co"> * No child process is created</span>
<span class="co"> */</span>
<span class="kw">if</span> (pid &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;fork&quot;</span>);
    exit(EXIT_FAILURE);
}

<span class="co">/* We are now killing the parent process</span>
<span class="co"> * parent exits -&gt; init &quot;takes the lead&quot;</span>
<span class="co"> */</span>
<span class="kw">if</span> (pid &gt; <span class="dv">0</span>)
    exit(EXIT_SUCCESS);</code></pre>
<p>Because we want to have a completely new controlling terminal we need to make our process be a session leader using <code>setsid()</code>. The above <code>fork</code> was needed just to allow this to succeed:</p>
<pre class="sourceCode c"><code class="sourceCode c">sessionID=setsid();
<span class="kw">if</span> (sessionID &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;setsid&quot;</span>);
    exit(EXIT_FAILURE);
}</code></pre>
<p>Next step is to <code>fork()/exit()</code> again. Since the session leader is now dead our process can never get access to a controlling terminal:</p>
<pre class="sourceCode c"><code class="sourceCode c">pid = fork();
<span class="kw">if</span> (pid &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;fork&quot;</span>);
    exit(EXIT_FAILURE);
}

<span class="kw">if</span> (pid &gt; <span class="dv">0</span>)
    exit(EXIT_SUCCESS);</code></pre>
<p>Now, we will switch to the directory which contains the files needed for this daemon to run (for example in case of <code>dovecot</code> we would switch to <code>/run/dovectot</code> which contains the sockets for different mail queues). Or, we could switch to <code>/</code> (like <code>apache2</code> and <code>sshd</code> do for example) if we don’t want to change to a specific directory. Anyway, it is essential to change the current running directory to prevent cases where if the program was started in a <code>cwd</code> from a different partition that partition could no longer be <code>umount</code>ed.</p>
<pre class="sourceCode c"><code class="sourceCode c">change_dir = chdir(<span class="st">&quot;/&quot;</span>);
<span class="kw">if</span> (change_dir &lt; <span class="dv">0</span> ) {
    perror(<span class="st">&quot;chdir&quot;</span>);
    exit(EXIT_FAILURE);
}</code></pre>
<p>Though the following steps are optional, it is better to do them too to ensure a reproducible behaviour of our executable, no matter what state the system was when we started it.</p>
<p>Because a child process inherits file descriptors and file descriptors from his parent, we need to close them. We use <code>sysconf</code> to get the maximum number of opened file descriptors in order to close all of them and prevent leaks. Then, we will set <code>umask</code> to 0 to gain complete permissions over anything we write.</p>
<pre class="sourceCode c"><code class="sourceCode c">maxfd = sysconf(_SC_OPEN_MAX);
<span class="kw">if</span> (maxfd &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;sysconf _SC_OPEN_MAX&quot;</span>);
    exit(EXIT_FAILURE);
}

<span class="kw">for</span> (fd = <span class="dv">0</span>; fd &lt; maxfd; fd++)
    <span class="co">/* note that we ignore return code here */</span>
    close(fd);

umask(<span class="dv">0</span>);</code></pre>
<p>Now we should reopen the 3 standard file descriptors. We can point them to <code>/dev/null</code> or to specific log files. Here we open all of them to <code>/dev/null</code>:</p>
<pre class="sourceCode c"><code class="sourceCode c">fd = open(<span class="st">&quot;/dev/null&quot;</span>, <span class="dv">0</span>);
<span class="kw">if</span> (fd &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;open /dev/null&quot;</span>);
    exit(EXIT_FAILURE);
}

status = dup2(fd, <span class="dv">0</span>);
<span class="kw">if</span> (status &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;dup 0&quot;</span>);
    exit(EXIT_FAILURE);
}
status = dup2(fd, <span class="dv">1</span>);
<span class="kw">if</span> (status &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;dup 1&quot;</span>);
    exit(EXIT_FAILURE);
}
status = dup2(fd, <span class="dv">2</span>);
<span class="kw">if</span> (status &lt; <span class="dv">0</span>) {
    perror(<span class="st">&quot;dup 2&quot;</span>);
    exit(EXIT_FAILURE);
}</code></pre>
<p>We now, have a fully working daemon, created by us. However, certain considerations must be taken:</p>
<ol type="1">
<li>First, if our code is to be launched by <code>inetd</code> then only the <code>chdir</code> and <code>umask</code> steps are useful. No <code>fork</code> and <code>setsid</code> should be called (otherwise <code>inetd</code> will get confused) and all other steps are already done by <code>inetd</code>.</li>
<li>Second, all of the above code is already implemented in the <code>daemon</code> function call with slightly less control over the end-result. It might be easier to use it instead of all of the above steps.</li>
</ol>
<p>All is good and nice but what if we want to daemonize a normal process? Well, we can use <code>nohup</code>, <code>disown</code> or <code>start-stop-daemon</code>. Or we could resort to special services to start our daemons like <code>inetd</code> and <code>upstart</code>.</p>
</section>
<section id="using-nohup-for-daemonizing-processes" class="level3">
<h3>Using nohup for daemonizing processes</h3>
<p><code>nohup</code> is a command which is used to run a command which ignores the HUP (hangup) signal. The HUP signal is used by a terminal to warn dependent processes of logout. Thus, processes started with <code>nohup</code> won’t be killed after the <code>tty</code> is destroyed.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">nohup</span> sleep 10000 <span class="kw">&amp;</span>
[<span class="kw">1</span>] 5470
<span class="kw">nohup</span>: ignoring input and appending output to ‘nohup.out’
$ <span class="kw">exit</span></code></pre>
<p>Now open a new terminal and</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">pgrep</span> sleep
<span class="kw">5470</span></code></pre>
<p>We can simulate <code>nohup</code> inside our C code too. Let’s configure signal handlers:</p>
<pre class="sourceCode c"><code class="sourceCode c">memset (&amp;sig_act, <span class="dv">0</span> , <span class="kw">sizeof</span>(sig_act));
<span class="co">/* Ignore SIGHUP signal */</span>
<span class="kw">if</span> (signal(SIGHUP, SIG_IGN) == SIG_ERR){
    perror(<span class="st">&quot;signal&quot;</span>);
    exit(EXIT_FAILURE);
}</code></pre>
<p>Now, if <code>stdout</code> is a terminal we have to redirect output to a file, just like the original command does:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span>(isatty(fileno(stdout))) {
    rc = open (<span class="st">&quot;nohup.out&quot;</span>, O_WRONLY | O_CREAT, <span class="dv">0644</span>);
    <span class="kw">if</span> (rc &lt; <span class="dv">0</span>) {
        perror(<span class="st">&quot;open&quot;</span>);
        exit(EXIT_FAILURE);
    }
    rc = dup2(rc, STDOUT_FILENO);
    <span class="kw">if</span> (rc &lt; <span class="dv">0</span>) {
        perror(<span class="st">&quot;dup2&quot;</span>);
        exit(EXIT_FAILURE);
    }
}</code></pre>
<p>Then we can <code>fork</code> and <code>exec</code> to get to our new process.</p>
<p>Let’s test it now (<code>./a.out</code> is our test binary, it receives as arguments the command line to execute in <code>exec</code>):</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">./a.out</span> gedit <span class="kw">&amp;</span>
[<span class="kw">1</span>] 22727</code></pre>
<p>After we close the terminal and open a new one, we clearly see that the process will be adopted by <code>init</code>:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ps</span> -ef <span class="kw">|</span> <span class="kw">grep</span> gedit
<span class="kw">matei</span>    22727     1  2 18:25 ?        00:00:01 gedit</code></pre>
</section>
<section id="disowning-a-process" class="level3">
<h3>Disowning a process</h3>
<p>What if we already started the process and forgot to use <code>nohup</code>? We can use <code>disown</code> to remove the process from the current session hierarchy, thus making it able to survive when the <code>tty</code> is closed.</p>
<p>Our first job is to use <code>^Z</code> to stop/pause the program and to go back to terminal. Then we have to use <code>bg</code> to run it in the background.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">gedit</span>
^<span class="kw">Z</span>
[<span class="kw">1</span>]+  Stopped                 gedit
$ <span class="kw">bg</span>
[<span class="kw">1</span>]+ gedit <span class="kw">&amp;</span></code></pre>
<p>Now, we use <code>disown</code> with the <code>-h</code> option, to mark the process so that <code>SIGHUP</code> is not gonna be received. If we don’t use the <code>-h</code> option the process is also removed from the current jobs table, which is something we like to do anyway:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">disown</span></code></pre>
<p>If we go to another terminal, we should see that the process has been adopted by <code>init</code>:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ps</span> -ef <span class="kw">|</span> <span class="kw">grep</span> gedit
<span class="kw">matei</span>    23087 22921  8 18:38 pts/6    00:00:01 gedit</code></pre>
<p>What happened? Our <code>gedit</code> process is not adopted by <code>init</code>. This is because we haven’t yet closed the terminal in which we have launched it. After closing it we have</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ps</span> -ef <span class="kw">|</span> <span class="kw">grep</span> gedit
<span class="kw">matei</span>    12490     1  1 07:07 ?        00:00:00 gedit</code></pre>
<p>To conclude:</p>
<ul>
<li>we need to use daemons for autonomous tasks</li>
<li>we have multiple ways for creating daemons</li>
<li>we can control daemons using signals and config files</li>
</ul>
<p>All other methods will be presented in a second part article.</p>
</section>

    </div>
  </div>
</div>

<!-- Social Buttons here -->
<div id="sociallinks">
  <a href="https://twitter.com/home?status=/daemonizing-processes.html" target="_blank">Tweet this</a> -
  <a href="http://www.facebook.com/sharer/sharer.php?u=/daemonizing-processes.html" target="_blank">Like this</a> -
  <a href="https://plus.google.com/share?url=/daemonizing-processes.html" target="_blank">Share on G+</a>
</div>

<script>
  (function(){window.addEventListener("DOMContentLoaded",function(){
    //get URL
    var url=document.location;
    var links=document.getElementById("sociallinks")
                      .getElementsByTagName('a');
    for (var i=0;i!=links.length;i++){
      // Replacing /daemonizing-processes.html with current URL
      links[i].setAttribute("href",links[i].href.replace('/daemonizing-processes.html',url));
    }})})();
</script>
</br>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'rosedutechblog';
  var disqus_url = window.location.href.split('/').splice(0,3).join("/")+'/daemonizing-processes.html';
  var title = 'Daemonizing Processes - Part 1';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

              </article>
              
            </div>
          </div>
        </div>
      </div>

      <footer class="the-footer">
        <div class="unit-foot">
          <div class="unit-inner unit-foot-inner">
            <div class="misc vcard">
              <h4>Social</h4>
              <div class="rss">
                <a href="http://techblog.rosedu.org/rss.xml" target="_blank">
                  <img src="./images/rss.png" alt="Subscribe to RSS Feed" />
                </a>
                <a href="http://www.reddit.com/submit?url='+encodeURIComponent(window.location)" target="_blank" onclick="window.location='http://www.reddit.com/submit?url='+encodeURIComponent(window.location); return false">
                  <img src="./images/reddit.png" alt="Submit to Reddit" />
                </a>
                <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" target="_blank">
                  <img src="./images/twitter.png" alt="Submit to Twitter" />
                </a>
              </div>

              <h4>Powered by</h4>
              <ul>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://www.rosedu.org">ROSEdu</a>
                  </address>
                </li>
                <li class="contact">
                  <address>
                    <a class="author fn n" href="http://jaspervdj.be/hakyll">Hakyll</a>
                  </address>
                </li>
              </ul>

              <h4>License</h4>
              <div class="bucket">
                <span>
                  <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution 3.0 License">
                    <img src="//i.creativecommons.org/l/by/3.0/88x31.png" alt="License">
                  </a>
                </span>
                <span>
                  This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" class="subfoot">Creative Commons Attribution 3.0 License</a>.
                </span>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>
